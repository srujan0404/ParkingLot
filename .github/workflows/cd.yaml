name: Continuous Deployment to Kubernetes

on:
  workflow_run:
    workflows: ["Parking Lot CI/CD Pipeline"]
    types:
      - completed
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Local Kubernetes
    runs-on: self-hosted
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Ensure Docker is Running
        run: |
          echo "Checking Docker status..."
          if ! docker info > /dev/null 2>&1; then
            echo "Docker is not running. Starting Docker Desktop..."
            open -a Docker
            echo "Waiting for Docker to start..."
            for i in {1..30}; do
              if docker info > /dev/null 2>&1; then
                echo "Docker is running"
                break
              fi
              echo "Waiting... ($i/30)"
              sleep 2
            done
            if ! docker info > /dev/null 2>&1; then
              echo "Failed to start Docker"
              exit 1
            fi
          else
            echo "Docker is already running"
          fi

      - name: Ensure Minikube is Running
        run: |
          echo "Checking Minikube status..."
          if ! minikube status > /dev/null 2>&1; then
            echo "Minikube is not running. Starting Minikube..."
            minikube start
          else
            echo "Minikube is already running"
          fi

      - name: Configure kubectl for Minikube
        run: |
          echo "Configuring kubectl context..."
          minikube update-context
          kubectl cluster-info
          echo "Kubernetes context configured"

      - name: Configure Docker for Minikube
        run: |
          echo "Configuring Docker for Minikube..."
          eval $(minikube docker-env)
          docker info | head -5
          echo "Docker configured"

      - name: Build Docker Image
        run: |
          echo "Building Docker image..."
          eval $(minikube docker-env)
          docker build -t parking-lot-app:${{ github.sha }} .
          docker tag parking-lot-app:${{ github.sha }} parking-lot-app:latest
          echo "Image built successfully"

      - name: Update Deployment Image
        run: |
          echo "Updating deployment manifest..."
          sed -i.bak "s|image: parking-lot-app:latest|image: parking-lot-app:${{ github.sha }}|g" k8s/deployment.yaml || \
          sed -i '' "s|image: parking-lot-app:latest|image: parking-lot-app:${{ github.sha }}|g" k8s/deployment.yaml
          cat k8s/deployment.yaml | grep -A2 "image:"
          echo "Deployment manifest updated"

      - name: Deploy to Kubernetes
        run: |
          echo "Deploying to Kubernetes..."
          kubectl apply -f k8s/namespace.yaml
          kubectl apply -f k8s/configmap.yaml
          kubectl apply -f k8s/deployment.yaml
          kubectl apply -f k8s/service.yaml
          echo "Deployment completed"

      - name: Wait for Deployment
        run: |
          echo "Waiting for pods to be ready..."
          kubectl rollout status deployment/parking-lot-app -n parking-lot --timeout=120s || echo "Note: Pods may restart if application exits"

      - name: Check Deployment Status
        run: |
          echo "Deployment Status:"
          kubectl get all -n parking-lot
          echo ""
          echo "Pod Details:"
          kubectl get pods -n parking-lot -o wide

      - name: View Application Logs
        if: always()
        run: |
          echo "Application Logs:"
          kubectl logs -l app=parking-lot -n parking-lot --tail=20 || echo "No logs available yet"
